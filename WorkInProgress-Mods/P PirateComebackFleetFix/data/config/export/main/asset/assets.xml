<ModOps>
    

    
   <!-- verwendet Serp GUIDs von 1500001101 bis einschließlich 1500001116 (freigehalten bis einschließlich 1500001130) -->


    
   <!-- This mod fill fix: -->
   <!-- Spawned pirate ships, eg by my SpawnShips.xml, but also by the game (the ComeBackFleet) do not leave the map when the pirates are defeated. -->
    <!-- (the others leave map as soon as harbor is destroyed, even if pirate is not defeated this way) -->
    <!-- This "not leaving" also resulted in ships not moving anymore, after pirates resettled without you destroying these not left ships -->
   <!-- Also the comeback fleet will shoot even at friends of pirates (because they are spawned as General_Enemy) -->
    
    <!-- Unfortunately the Pirate defeated/comeback vanilla code is very buggy and most of it is not accessable for modders. So we can only use workarounds to kind of "fix" the issues: -->
     <!-- - ComebackFleet does not count to Warfleet, so after resettle pirate will produce ships and will have the whole warfleet plus comeback fleet. -->
     <!-- - If you save and load a savegame, while the Quest to destory the comeback fleet is active (or even shortly before when the comebackfleet is on their way to harbor), this quest will vanish and a new comeback fleet will soon arive, resulting in 2 or more comeback fleets (this is already the result of a "fix" from ubisoft, before that fix the pirates would never resettle after loading such a savegame) -->
     <!--   this mod will remove the first now useless fleet on loading a savegame -->
     <!-- - warfleet ships already leaving the map after harbor is destryoed, although pirates are not yet defeated (could be intended, but there is no event for pirate defeated, so the devs maybe had no other choice than this) -->
    <!-- - When you were not at war with pirates while the comebackfleet arrives (eg. because AI destryoed them or you used pirate flag item to destroy base), then the background quests to resettle were never started and pirates never rebuilt. Bypass was to declare war and wait for the next fleet. -->
    <!--   -> just starting the quests manually after the ships are spawned does not help, because the repair from the base itself is also hardcoded and not triggered by these quests    -->
    <!--      so only solution is to make sure that the quests are correctly triggered from the hardcoded code, and since we can not fix it, we have everyone to declare war on pirates when they are destroyed and try to restore it when comebackfleet arrives -->
    
    <!-- 8) Although the comebackfleet as "UseDangerLayer=1" defined, they still simply drive through island denfense and get shot.  -->
    <!--    I see no way to fix this beside making the owner "Neutral" while the ships drive to the harbor. But I think this is not a good solution, so not implemented with this mod. -->



    <!-- Minor Problem: -->
    <!-- The comeback fleet from LaFortune moves for whatever reason away from the harbor. -->
     <!-- it is related to MilitaryAI/Attack/AttackInterval, but it does not happen to Harlow for whatever reason and the ships dont attack, they simply move to another point. -->
     <!-- therefore we will start the visible resettle quest already after the comebackfleet spawned, not when it reaches the harbor (because LaFortune may not reach the harbor) -->
    
    
    
    <!-- ComeBackFleet adjustments: -->
    
    <!-- we will start the visible "destroy fleet" quest already when the ships spawn, so add 5 minutes to QuestLimit, because -->
     <!-- the ships might take this long to reach the harbor -->

    <!-- 153279 und 153280 sind nur fake quests um ein Reparatursymbol über den Kontor zu spawnen (Destroy quests ist unerfuellbar, auch weil sie keine Gebäude kann) und werden automatisch beendet, wenn 153264/153273 erfoglreich oder fail sind. -->
    <!-- aber ich denke es schadet dennoch nicht auch für sie ein questlimit einzutragen, by default haben sie ja auch dasselbe -->
    <!-- 35 instead of 30 minutes vanilla -->
    <ModOp Type="merge" GUID="153264,153279,153273,153280" Path="/Values/Quest">
      <QuestTimeLimit>2100000</QuestTimeLimit>
    </ModOp>
    <!-- if my stronger pirates mod is active, 25 instead of 20 minutes -->
    <Group Condition="#Stronger_Pirates_Serp">
        <ModOp Type="merge" GUID="153264,153279,153273,153280" Path="/Values/Quest">
          <QuestTimeLimit>1500000</QuestTimeLimit>
        </ModOp>
    </Group>
    
    <!-- change spawn owner to pirates -->
    <ModOp Type="merge" GUID='153266,153269,153236,153270,153271,153233' Path="/Values/Trigger/TriggerActions/Item/TriggerAction[Template='ActionSpawnObjects']/Values/ActionSpawnObjects">
        <Owner>Third_party_03_Pirate_Harlow</Owner>
    </ModOp>
    <!-- tell the stupid game to only move comebackfleet if it is owend by pirate (only theoretical problem, but still better this way) -->
    <!-- but it seems this is also ignored here , just like PrebuiltObjectOwner and owner for ActionDeleteObjects ... stupid game -->
     <!-- but its only a problem if neutral comebackfleet is still there when new fleet arrives and this should not happen if comeback timer is at least 5 minutes -->
    <ModOp Type="merge" GUID='153266,153269,153236,153270,153271,153233' Path="/Values/Trigger/TriggerActions/Item/TriggerAction[Template='ActionMoveObject']/Values/ObjectFilter">
        <CheckParticipantID>1</CheckParticipantID>
        <ObjectParticipantID>Third_party_03_Pirate_Harlow</ObjectParticipantID>
    </ModOp>
    <!-- Remove all old resettle group ships instantly, if there are still some left on the map (because they are most likey Neutral meanwhile and can not be destryoed anymore and the check to only affect ships from pirate does not work for whatever reason) -->
    <!-- remove all neutral pirate ships instead, because with ObjectLabel ObjectParticipantID is ignored and some mods add multiple Trigger to PossibleQuests, so it would remove the ones the previous trigger spawned otherwise -->
    <ModOp Type="AddPrevSibling" GUID='153266,153269,153236,153270,153271,153233' Path="/Values/Trigger/TriggerActions/Item[TriggerAction/Template='ActionSpawnObjects']">
        <Item>
          <TriggerAction>
            <Template>ActionDeleteObjects</Template>
            <Values>
              <Action />
              <ActionDeleteObjects>
                <ShipsLeaveMapFirst>0</ShipsLeaveMapFirst>
              </ActionDeleteObjects>
              <ObjectFilter>
                <!-- <ObjectLabel>PirateHarlowResettleGroup</ObjectLabel> -->
                <ObjectGUID>700138</ObjectGUID>
                <CheckParticipantID>1</CheckParticipantID>
                <ObjectParticipantID>Neutral</ObjectParticipantID>
                <ObjectSession>180023</ObjectSession>
              </ObjectFilter>
            </Values>
          </TriggerAction>
        </Item>
    </ModOp>
    <ModOp Type="merge" GUID='153262,153264' Path="/Values/Objectives/WinConditions/Item/Objective/Values/ConditionQuestDestroy/DestroyObjectsPrebuilt/Item/DestroyObject/Values/ConditionObjectPrebuiltObject">
        <PrebuiltObjectCheckOwner>1</PrebuiltObjectCheckOwner>
        <PrebuiltObjectOwner>Third_party_03_Pirate_Harlow</PrebuiltObjectOwner>
    </ModOp>
    <!-- LaFortune -->
    <ModOp Type="merge" GUID='153274,153275,153240,153276,153277,153241' Path="/Values/Trigger/TriggerActions/Item/TriggerAction[Template='ActionSpawnObjects']/Values/ActionSpawnObjects">
        <Owner>Third_party_04_Pirate_LaFortune</Owner>
    </ModOp>
    <ModOp Type="merge" GUID='153274,153275,153240,153276,153277,153241' Path="/Values/Trigger/TriggerActions/Item/TriggerAction[Template='ActionMoveObject']/Values/ObjectFilter">
        <CheckParticipantID>1</CheckParticipantID>
        <ObjectParticipantID>Third_party_04_Pirate_LaFortune</ObjectParticipantID>
    </ModOp>
    <!-- Remove all old resettle group ships instantly, if there are still some left on the map (because they are most likey Neutral meanwhile and can not be destryoed anymore and the check to only affect ships from pirate does not work for whatever reason). this can only happen if the next comebackfleet arrives before the previous fleet finished moving off the map -->
     <!-- remove all neutral pirate ships instead, because with ObjectLabel ObjectParticipantID is ignored and some mods add multiple Trigger to PossibleQuests, so it would remove the ones the previous trigger spawned otherwise -->
    <ModOp Type="AddPrevSibling" GUID='153274,153275,153240,153276,153277,153241' Path="/Values/Trigger/TriggerActions/Item[TriggerAction/Template='ActionSpawnObjects']">
        <Item>
          <TriggerAction>
            <Template>ActionDeleteObjects</Template>
            <Values>
              <Action />
              <ActionDeleteObjects>
                <ShipsLeaveMapFirst>0</ShipsLeaveMapFirst>
              </ActionDeleteObjects>
              <ObjectFilter>
                <!-- <ObjectLabel>PirateLafortuneResettleGroup</ObjectLabel> -->
                <ObjectGUID>700138</ObjectGUID>
                <CheckParticipantID>1</CheckParticipantID>
                <ObjectParticipantID>Neutral</ObjectParticipantID>
                <ObjectSession>180025</ObjectSession>
              </ObjectFilter>
            </Values>
          </TriggerAction>
        </Item>
    </ModOp>
    <ModOp Type="merge" GUID='153272,153273' Path="/Values/Objectives/WinConditions/Item/Objective/Values/ConditionQuestDestroy/DestroyObjectsPrebuilt/Item/DestroyObject/Values/ConditionObjectPrebuiltObject">
        <PrebuiltObjectCheckOwner>1</PrebuiltObjectCheckOwner>
        <PrebuiltObjectOwner>Third_party_04_Pirate_LaFortune</PrebuiltObjectOwner>
    </ModOp>
    
    <!-- the check for ships reached harbor to start the resettle quest, check for pirate owner instead of General_Enemy (152282 and 152331 belong to quest 152280 and the fortuna counterpart and are not used by the game anymore) -->
    <!-- -> not needed anymore, because we start visible quest directly after spawn, and do not care for the ships in range check anymore -->
    <!-- <ModOp Type="replace" GUID='152282,153263' Path="/Values/Trigger/TriggerCondition/Values/ConditionShipsInRange/ShipOwnerParticipant"> -->
        <!-- <ShipOwnerParticipant>Third_party_03_Pirate_Harlow</ShipOwnerParticipant> -->
    <!-- </ModOp> -->
    <!-- <ModOp Type="replace" GUID='152331,153278' Path="/Values/Trigger/TriggerCondition/Values/ConditionShipsInRange/ShipOwnerParticipant"> -->
        <!-- <ShipOwnerParticipant>Third_party_04_Pirate_LaFortune</ShipOwnerParticipant> -->
    <!-- </ModOp> -->
    
    <!-- Change Owner to General_Enemy first and the vanilla code will change it back to pirate. This change allows the Pirates to freely control the ships (seems to be no better solution) -->
    <ModOp Type="AddPrevSibling" GUID='153264' Path="/Values/Quest/OnQuestFailed/Values/ActionList/Actions/Item[Action/Template='ActionChangeParticipant']">
      <Item>
        <Action>
          <Template>ActionChangeParticipant</Template>
          <Values>
            <Action />
            <ActionChangeParticipant>
              <NewParticipantID>General_Enemy</NewParticipantID>
            </ActionChangeParticipant>
            <ObjectFilter>
              <ObjectLabel>PirateHarlowResettleGroup</ObjectLabel>
              <ObjectSession>180023</ObjectSession>
            </ObjectFilter>
          </Values>
        </Action>
      </Item>
    </ModOp>
    <ModOp Type="AddPrevSibling" GUID='153273' Path="/Values/Quest/OnQuestFailed/Values/ActionList/Actions/Item[Action/Template='ActionChangeParticipant']">
      <Item>
        <Action>
          <Template>ActionChangeParticipant</Template>
          <Values>
            <Action />
            <ActionChangeParticipant>
              <NewParticipantID>General_Enemy</NewParticipantID>
            </ActionChangeParticipant>
            <ObjectFilter>
              <ObjectLabel>PirateLafortuneResettleGroup</ObjectLabel>
              <ObjectSession>180025</ObjectSession>
            </ObjectFilter>
          </Values>
        </Action>
      </Item>
    </ModOp>
    
    
    
    
    <!-- Make the ships leave session when pirates are defeated -->

    <!-- Trigger is executed once for all human players, so multiple times in multiplayer. But this should be no problem -->
    
    <!-- hitting also the warfleet ships (eg GUID 700138) with the delete command bugs out the warfleet (not making more ships, although there are none anymore) -->
    <!-- So we can only use ObjectLabel to not hit the original warfleet! -->
     <!-- this means we can not hit pirate ships from other mods except we add them here (this mod loads last to be able to copy the WarFleets from other mods) -->
    <!-- not 100% sure, might also have been another bug. But I think it is more save to only work with ObjectLabels, cause these are the spawned ships that are not leaving map -->
    
    <ModOp Type="add" GUID="1500001140" Path="/Values/Trigger/TriggerActions">
        <!-- we change owner to Neutral, otherwise the pirate ships will ignore their command to leave map, if they shoot at anything -->
        <!-- short delay is important to not mess with the vanilla code for warfleet ships -->
        <Item>
          <TriggerAction>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>2000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                          <Action>
                            <Template>ActionChangeParticipant</Template>
                            <Values>
                              <Action />
                              <ActionChangeParticipant>
                                <NewParticipantID>Neutral</NewParticipantID>
                              </ActionChangeParticipant>
                              <ObjectFilter>
                                <ObjectLabel>PirateHarlowResettleGroup</ObjectLabel>
                                <ObjectSession>180023</ObjectSession>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Third_party_03_Pirate_Harlow</ObjectParticipantID>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                        <Item>
                          <Action>
                            <Template>ActionChangeParticipant</Template>
                            <Values>
                              <Action />
                              <ActionChangeParticipant>
                                <NewParticipantID>Neutral</NewParticipantID>
                              </ActionChangeParticipant>
                              <ObjectFilter>
                                <ObjectLabel>PirateHarlowWarfleetSerp</ObjectLabel>
                                <ObjectSession>180023</ObjectSession>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Third_party_03_Pirate_Harlow</ObjectParticipantID>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </TriggerAction>
        </Item>
        <Item>
          <TriggerAction>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>3000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <!-- for whatever reason ObjectParticipantID here is ignored, all ships matching from everyone will leave map. -->
                        <!-- so make sure it can only be ships owned by the pirates and NOT part of the vanilla warfleet (eg via ObjectLabel they got on spawn command) -->
                        <Item>
                          <Action>
                            <Template>ActionDeleteObjects</Template>
                            <Values>
                              <Action />
                              <ActionDeleteObjects>
                                <ShipsLeaveMapFirst>1</ShipsLeaveMapFirst>
                              </ActionDeleteObjects>
                              <ObjectFilter>
                                <ObjectLabel>PirateHarlowResettleGroup</ObjectLabel>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Neutral</ObjectParticipantID>
                                <ObjectSession>180023</ObjectSession>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                        <Item>
                            <Action>
                              <Template>ActionDeleteObjects</Template>
                              <Values>
                                <Action />
                                <ActionDeleteObjects>
                                  <ShipsLeaveMapFirst>1</ShipsLeaveMapFirst>
                                </ActionDeleteObjects>
                                <ObjectFilter>
                                  <ObjectLabel>PirateHarlowWarfleetSerp</ObjectLabel>
                                  <CheckParticipantID>1</CheckParticipantID>
                                  <ObjectParticipantID>Neutral</ObjectParticipantID>
                                  <ObjectSession>180023</ObjectSession>
                                </ObjectFilter>
                              </Values>
                            </Action>
                          </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </TriggerAction>
        </Item>
    </ModOp>

    <ModOp Type="add" GUID="1500001144" Path="/Values/Trigger/TriggerActions">
        <!-- we change owner to Neutral, otherwise the pirate ships will ignore their command to leave map, if they shoot at anything -->
        <!-- short delay is important to not mess with the vanilla code for warfleet ships -->
        <Item>
          <TriggerAction>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>2000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                          <Action>
                            <Template>ActionChangeParticipant</Template>
                            <Values>
                              <Action />
                              <ActionChangeParticipant>
                                <NewParticipantID>Neutral</NewParticipantID>
                              </ActionChangeParticipant>
                              <ObjectFilter>
                                <ObjectLabel>PirateLafortuneResettleGroup</ObjectLabel>
                                <ObjectSession>180025</ObjectSession>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Third_party_04_Pirate_LaFortune</ObjectParticipantID>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                        <Item>
                          <Action>
                            <Template>ActionChangeParticipant</Template>
                            <Values>
                              <Action />
                              <ActionChangeParticipant>
                                <NewParticipantID>Neutral</NewParticipantID>
                              </ActionChangeParticipant>
                              <ObjectFilter>
                                <ObjectLabel>PirateLafortuneWarfleetSerp</ObjectLabel>
                                <ObjectSession>180025</ObjectSession>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Third_party_04_Pirate_LaFortune</ObjectParticipantID>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </TriggerAction>
        </Item>
        <Item>
          <TriggerAction>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>3000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <!-- for whatever reason ObjectParticipantID here is ignored, all ships matching from everyone will leave map. -->
                        <!-- so make sure it can only be ships owned by the pirates and NOT part of the vanilla warfleet (eg via ObjectLabel they got on spawn command) -->
                        <Item>
                          <Action>
                            <Template>ActionDeleteObjects</Template>
                            <Values>
                              <Action />
                              <ActionDeleteObjects>
                                <ShipsLeaveMapFirst>1</ShipsLeaveMapFirst>
                              </ActionDeleteObjects>
                              <ObjectFilter>
                                <ObjectLabel>PirateLafortuneResettleGroup</ObjectLabel>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Neutral</ObjectParticipantID>
                                <ObjectSession>180025</ObjectSession>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                        <Item>
                          <Action>
                            <Template>ActionDeleteObjects</Template>
                            <Values>
                              <Action />
                              <ActionDeleteObjects>
                                <ShipsLeaveMapFirst>1</ShipsLeaveMapFirst>
                              </ActionDeleteObjects>
                              <ObjectFilter>
                                <ObjectLabel>PirateLafortuneWarfleetSerp</ObjectLabel>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Neutral</ObjectParticipantID>
                                <ObjectSession>180025</ObjectSession>
                              </ObjectFilter>
                            </Values>
                          </Action>
                        </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </TriggerAction>
        </Item>
    </ModOp>
    
    
    
    
    
    <!-- Bug: -->
    <!-- If you save and load a savegame, while the Quest to destory the comeback fleet is active, this quest will vanish and a new comeback fleet will soon arive, resulting in 2 or more comeback fleets -->
    <!-- Solution: -->
    <!-- Removing the first useless combackfleet when the resttle quest is aborted on loading a savegame -->
    
    <!-- seems we have to use OnQuestEnd, because Aborted and everything else is not fired for this most likely exceptional abort -.- -->
    <!-- so we need to check if pirate harbour is repaired afterwards or not, to decide it we remove the resettlefleet or not -->
    <!-- remove the start of the trigger 153263, cause it is not needed anymore, since his action is in OnQuestStart now -->
    <ModOp Type="remove" GUID="153262" Path="/Values/Quest/OnQuestEnd/Values/ActionList/Actions/Item[Action/Values/ActionRegisterTrigger/TriggerAsset='153263']" />
    <ModOp Type="add" GUID="153262" Path="/Values/Quest/OnQuestEnd/Values/ActionList/Actions">
        <Item>
          <Action>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>1000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                          <Action>
                            <Template>ActionRegisterTrigger</Template>
                            <Values>
                              <Action />
                              <ActionRegisterTrigger>
                                <TriggerAsset>1500001103</TriggerAsset>
                              </ActionRegisterTrigger>
                            </Values>
                          </Action>
                        </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </Action>
        </Item>
    </ModOp>
    <!-- start the visible resettle quests already when the comebackfleet spawns, this way it is no problem if the AI gives them any move command during the quest and it does not matter if they reach the harbor and if the ShipOwnerParticipant is General_Enemy or pirate (makes trigger 153263 obsolete) -->
    <!-- remove the start of the trigger 153263, cause it is not needed anymore, since his action is here now -->
    <ModOp Type="remove" GUID="153262" Path="/Values/Quest/OnQuestStart/Values/ActionList/Actions/Item[Action/Values/ActionRegisterTrigger/TriggerAsset='153263']" />
    <ModOp Type="add" GUID="153262" Path="/Values/Quest/OnQuestStart/Values/ActionList/Actions">
        <Item>
          <Action>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>5000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                            <Action>
                              <Template>ActionStartQuest</Template>
                              <Values>
                                <Action />
                                <ActionStartQuest>
                                  <Quest>153264</Quest>
                                  <InheritQuestArea>1</InheritQuestArea>
                                  <InheritQuestSession>1</InheritQuestSession>
                                </ActionStartQuest>
                              </Values>
                            </Action>
                          </Item>
                          <Item>
                            <Action>
                              <Template>ActionStartQuest</Template>
                              <Values>
                                <Action />
                                <ActionStartQuest>
                                  <Quest>153279</Quest>
                                  <InheritQuestSession>1</InheritQuestSession>
                                </ActionStartQuest>
                              </Values>
                            </Action>
                          </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </Action>
        </Item>
    </ModOp>
    
    <!-- remove the start of the trigger 153278, cause it is not needed anymore, since his action is in OnQuestStart now -->
    <ModOp Type="remove" GUID="153272" Path="/Values/Quest/OnQuestEnd/Values/ActionList/Actions/Item[Action/Values/ActionRegisterTrigger/TriggerAsset='153278']" />
    <ModOp Type="add" GUID="153272" Path="/Values/Quest/OnQuestEnd/Values/ActionList/Actions">
        <Item>
          <Action>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>1000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                          <Action>
                            <Template>ActionRegisterTrigger</Template>
                            <Values>
                              <Action />
                              <ActionRegisterTrigger>
                                <TriggerAsset>1500001104</TriggerAsset>
                              </ActionRegisterTrigger>
                            </Values>
                          </Action>
                        </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </Action>
        </Item>
    </ModOp>
    <!-- start the visible resettle quests already when the comebackfleet spawns, this way it is no problem if the AI gives them any move command during the quest and it does not matter if they reach the harbor and if the ShipOwnerParticipant is General_Enemy or pirate (makes trigger 153278 obsolete) -->
    <!-- remove the start of the trigger 153278, cause it is not needed anymore, since his action is here now -->
    <ModOp Type="remove" GUID="153272" Path="/Values/Quest/OnQuestStart/Values/ActionList/Actions/Item[Action/Values/ActionRegisterTrigger/TriggerAsset='153278']" />
    <ModOp Type="add" GUID="153272" Path="/Values/Quest/OnQuestStart/Values/ActionList/Actions">
        <Item>
          <Action>
            <Template>ActionDelayedActions</Template>
            <Values>
              <Action />
              <ActionDelayedActions>
                <ExecutionDelay>5000</ExecutionDelay>
                <DelayedActions>
                  <IsBaseAutoCreateAsset>1</IsBaseAutoCreateAsset>
                  <Values>
                    <ActionList>
                      <Actions>
                        <Item>
                            <Action>
                              <Template>ActionStartQuest</Template>
                              <Values>
                                <Action />
                                <ActionStartQuest>
                                  <Quest>153273</Quest>
                                  <InheritQuestArea>1</InheritQuestArea>
                                  <InheritQuestSession>1</InheritQuestSession>
                                </ActionStartQuest>
                              </Values>
                            </Action>
                          </Item>
                          <Item>
                            <Action>
                              <Template>ActionStartQuest</Template>
                              <Values>
                                <Action />
                                <ActionStartQuest>
                                  <Quest>153280</Quest>
                                  <InheritQuestSession>1</InheritQuestSession>
                                </ActionStartQuest>
                              </Values>
                            </Action>
                          </Item>
                      </Actions>
                    </ActionList>
                  </Values>
                </DelayedActions>
              </ActionDelayedActions>
            </Values>
          </Action>
        </Item>
    </ModOp>
    
    
    
    <!-- check if after the resettle quest ended, the pirate base is repaired again. (we dont use ConditionEvent PiratesResettled, because I dont know how to check for specific pirate, guid as ContextAsset does not work) -->
    <!-- if it is not, it was most likely loading a savegame while pirate is resettling -->
    <!-- then remove the current comebackfleet, because the vanilla game will sent a new one after a while (we can not prevent this) -->
    <!-- and we dont want 2 comebackfleets at once, because it gets simply too much ships -->
    <!-- This also triggers if the successfully destryoed the comebackfleet, but ActionDeleteObjects does nothing in this case -->
     <!-- AND we want to to trigger in that case too, because we do the WarRelationRestore Stuff in this case too, see RelationRestore file -->
    <ModOp GUID="130248" Type="AddNextSibling">
		<Asset>
			<Template>Trigger</Template>
			<Values>
				<Standard>
					<GUID>1500001103</GUID>
				</Standard>
				<Trigger>
					<TriggerCondition>
            <Template>ConditionAlwaysTrue</Template>
            <Values>
              <Condition>
                <SubConditionCompletionOrder>MutuallyExclusive</SubConditionCompletionOrder>
              </Condition>
              <ConditionAlwaysTrue />
            </Values>
        </TriggerCondition>
        <SubTriggers>
            <Item>
              <SubTrigger>
                <Template>AutoCreateTrigger</Template>
                <Values>
                  <Trigger>
                    <TriggerCondition>
                        <Template>ConditionPlayerCounter</Template>
                        <Values>
                          <Condition>
                            <!-- use IsOptional because we want to "defuse" this trigger regardless what the case is. but if it is ruin, do the action below -->
                            <IsOptional>1</IsOptional>
                          </Condition>
                          <ConditionPlayerCounter>
                            <PlayerCounter>RuinCount</PlayerCounter>
                            <Context>100681</Context>
                            <CounterAmount>1</CounterAmount>
                            <ComparisonOp>AtLeast</ComparisonOp>
                            <CheckSpecificParticipant>1</CheckSpecificParticipant>
                            <CheckedParticipant>Third_party_03_Pirate_Harlow</CheckedParticipant>
                          </ConditionPlayerCounter>
                        </Values>
                    </TriggerCondition>
                    <TriggerActions>
                        <Item>
                          <TriggerAction>
                            <Template>ActionDeleteObjects</Template>
                            <Values>
                              <Action />
                              <ActionDeleteObjects>
                                <ShipsLeaveMapFirst>0</ShipsLeaveMapFirst>
                              </ActionDeleteObjects>
                              <ObjectFilter>
                                <ObjectLabel>PirateHarlowResettleGroup</ObjectLabel>
                                <CheckParticipantID>1</CheckParticipantID>
                                <ObjectParticipantID>Third_party_03_Pirate_Harlow</ObjectParticipantID>
                                <ObjectSession>180023</ObjectSession>
                              </ObjectFilter>
                            </Values>
                          </TriggerAction>
                        </Item>
                    </TriggerActions>
                  </Trigger>
                </Values>
              </SubTrigger>
            </Item>
        </SubTriggers>
				</Trigger>
				<TriggerSetup>
					<AutoRegisterTrigger>0</AutoRegisterTrigger>
					<UsedBySecondParties>0</UsedBySecondParties>
				</TriggerSetup>
			</Values>
		</Asset>
  
		<Asset>
			<Template>Trigger</Template>
			<Values>
				<Standard>
					<GUID>1500001104</GUID>
				</Standard>
				<Trigger>
					<TriggerCondition>
            <Template>ConditionAlwaysTrue</Template>
            <Values>
              <Condition>
                <SubConditionCompletionOrder>MutuallyExclusive</SubConditionCompletionOrder>
              </Condition>
              <ConditionAlwaysTrue />
            </Values>
          </TriggerCondition>
          <SubTriggers>
              <Item>
                <SubTrigger>
                  <Template>AutoCreateTrigger</Template>
                  <Values>
                    <Trigger>
                      <TriggerCondition>
                          <Template>ConditionPlayerCounter</Template>
                          <Values>
                            <Condition>
                              <!-- use IsOptional because we want to "defuse" this trigger regardless what the case is -->
                              <IsOptional>1</IsOptional>
                            </Condition>
                            <ConditionPlayerCounter>
                              <PlayerCounter>RuinCount</PlayerCounter>
                              <Context>100682</Context>
                              <CounterAmount>1</CounterAmount>
                              <ComparisonOp>AtLeast</ComparisonOp>
                              <CheckSpecificParticipant>1</CheckSpecificParticipant>
                              <CheckedParticipant>Third_party_04_Pirate_LaFortune</CheckedParticipant>
                            </ConditionPlayerCounter>
                          </Values>
                      </TriggerCondition>
                      <TriggerActions>
                          <Item>
                            <TriggerAction>
                              <Template>ActionDeleteObjects</Template>
                              <Values>
                                <Action />
                                <ActionDeleteObjects>
                                  <ShipsLeaveMapFirst>0</ShipsLeaveMapFirst>
                                </ActionDeleteObjects>
                                <ObjectFilter>
                                  <ObjectLabel>PirateLafortuneResettleGroup</ObjectLabel>
                                  <CheckParticipantID>1</CheckParticipantID>
                                  <ObjectParticipantID>Third_party_04_Pirate_LaFortune</ObjectParticipantID>
                                  <ObjectSession>180025</ObjectSession>
                                </ObjectFilter>
                              </Values>
                            </TriggerAction>
                          </Item>
                      </TriggerActions>
                    </Trigger>
                  </Values>
                </SubTrigger>
              </Item>
          </SubTriggers>
				</Trigger>
				<TriggerSetup>
					<AutoRegisterTrigger>0</AutoRegisterTrigger>
					<UsedBySecondParties>0</UsedBySecondParties>
				</TriggerSetup>
			</Values>
		</Asset>
	</ModOp>
    
    <!-- wenn wir irgendwo mit condition gucken können, -->
    <!-- ob es noch schiffe der comebackfleet gibt, (ConditionShipsOwnedInSession geht nicht mit Label, ginge also wenn nur alle piratenschiffe) -->
    <!-- dann könnte man bei dem Laden-check alternativ in dem fall auch einfach die 62+64 erneut starten, -->
    <!-- sodass es direkt beim laden weitergeht (zwar mit neuem timer, aber immerhin) -->
    <!-- und sobald das spiel diese quests nach ner zeit selbst nochmal startet, könnte man in den quests vorher schauen -->
     <!-- ob das noetig ist (zb precondition).. aber wie prüfen wir das? -->
     <!-- evlt prüfen ob 62/64 Quest bereits aktiv ist? Weiß garnicht ob quests merhfach aktiv sein können. -->
     <!-- uund auch prüfen (oder) ob piratenbasis wieder aufgebaut ist. -->
    <!-- dann gäbe es aber immernoch den edgecase was ist wenn piratenbasis mittlerweile weider aufgebaut und wieder zerstört wurde, -->
     <!-- es also bereits auf eine weitere comebackfleet gewartet wird? -->
      <!-- wäre nicht so schlimm, wenn dann quasi 2 fleets in warteschlage sind, weil die zweite dann ja wieder nicht spawnt, solange quest aktiv oder kontor heile -->
     <!-- wobei wenn eine zweite in warteschlange ist mit 20 minuten und ich die aktuelle fleet dann nach 19 minuten besiegt hab -->
      <!-- kommt schon eine minute später direkt die neue fleet bei der ich unmöglich wissen kann, dass es zu früh ist. -->
     <!-- -> daher lieber aufwand sparen und aktuell Lösung mit ActionDeleteObjects so lassen -->
    <!-- Alternativ system komplett selbst schreiben, sodass nach Defeat eine delayed Action startet, die dann selbst die Qeusts startet -->
     <!-- aber keine Ahnung ob DelayedActions savegame kompatibel ist (ja ist es). und wann pirate defeated ist ist auch kein sonderlich robuster code, da wir nicht prüfen können ob alle gebäude ruinen sind, ohne alle aufzulisten.. -->
    <!-- NEIN geht alles nicht, weil immernoch einige Dinge hardcoded sind. So steht in assets.xml zb nirgendwo, dass die Piratenbasis wieder heile gemacht wird, -->
     <!-- das ist hardcoded und nur die quests zu starten und den timer abzuwarten hilft hier nicht. -->
    
    <!-- ######################################################## -->
    <!-- ######################################################## -->
    
    <!-- The following 2 file includes will replace the original WarFleet of pirates with a one spawned by my triggers. -->
    <!-- The trigger will copy the current WarFleet and CraftingTimes, so should also be compatible to other mods modifying the WarFleet -->
    <!-- But it is still quite heavy code that increases the loadingtime of the game (on my system by 0.5 seconds, while normal mods usually only need 0.001 seconds) -->
    <!-- So feel free to outcomment these lines. They only fix the following two bugs: -->
    <!-- 1) Total amount of pirate ships over the intended amount (warfleet + comebackfleet) -->
    <!-- 2) warfleet leaving map already when harbour is destroyed -->
    <!-- And the triggers increase the spawning rate with multiple human players active (not coop), eg. it will spawn 3 ships at once with 3 human players. This was unintended and I don't know a way to "fix" this, but I think it is nice to have higher spawnrate with multiple human players. -->
    <Include File="/data/config/export/main/asset/SpawnWarFleetTrigger.include.xml" />
    <Include File="/data/config/export/main/asset/SpawnWarFleetFilling.include.xml" />
    
    <!-- Triggers to declare war on defeat and restore the previous relation to pirates as soon as the resettle quest starts -->
    <Include File="/data/config/export/main/asset/RelationRestore.include.xml" />
    
    
    
</ModOps>